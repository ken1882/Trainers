from copy import copy
import enum
from time import sleep

import cv2
import numpy as np
from desktopmagic.screengrab_win32 import getRectAsImage

import _G
import graphics
import Input
import position
import utils
from _G import log_debug, log_error, log_info, log_warning, resume, uwait, wait
from _G import CVMatchHardRate,CVMatchMinCount,CVMatchStdRate,CVLocalDistance
from utils import img2str, isdigit, ocr_rect
import re

Enum = {
  '_': {
    'pos': ((1,1),),
    'color': ((999,999,999),)
  },
  'PowerSaving': {
    'pos': ((1377, 513),(958, 291),(258, 357),(1225, 591),),
    'color': ((153, 227, 252),(81, 98, 134),(19, 21, 27),(162, 213, 246),)
  },
  'IdleMain': {
    'pos': ((503, 596),(325, 81),(71, 268),(597, 80),),
    'color': ((217, 224, 251),(166, 175, 207),(130, 147, 190),(195, 211, 236),)
  },
  'TavernMain': {
    'pos': ((338, 263),(103, 726),(1290, 419),),
    'color': ((198, 173, 153),(212, 220, 237),(219, 194, 104),)
  },
  'ChestOpen': {
    'pos': ((1432, 107),(1209, 121),(1224, 146),(803, 147),(544, 162),(1447, 913),),
    'color': ((218, 219, 219),(247, 239, 231),(176, 71, 90),(81, 86, 107),(62, 67, 84),(233, 204, 153),)
  },
  'TavernPlay': {
    'pos': ((1546, 410),(1580, 639),(1573, 820),(1648, 144),(1355, 137),(1669, 882),),
    'color': ((255, 208, 130),(248, 201, 73),(247, 213, 71),(163, 97, 81),(79, 85, 106),(229, 203, 152),)
  },
  'TavernDraw': {
    'pos': ((1448, 163),(1460, 183),(1229, 133),(1273, 437),(1267, 700),(1192, 461),(1258, 816),(1496, 886),),
    'color': ((247, 239, 231),(172, 71, 89),(76, 75, 129),(134, 235, 255),(207, 163, 138),(84, 89, 110),(130, 105, 86),(232, 204, 153),)
  },
  'TavernSign': {
    'pos': ((1604, 133),(1483, 397),(1437, 396),(1387, 396),(1587, 379),(1587, 536),(429, 180),(1586, 884),(1610, 887),),
    'color': ((215, 218, 219),(63, 71, 103),(61, 70, 103),(62, 71, 103),(56, 67, 96),(61, 72, 100),(223, 224, 227),(79, 87, 120),(230, 204, 153),)
  },
  'CharacterProfile_Main': {
    'pos': ((505, 430),(493, 132),(508, 723),(109, 116),(63, 111),(312, 397),),
    'color': ((239, 97, 125),(228, 188, 103),(1, 102, 154),(240, 150, 122),(15, 19, 19),(221, 224, 233),)
  },
  'ShopMenus':{
    'pos': ((1339, 16),(46, 36),(109, 425),(85, 456),(214, 869),(24, 406),),
    'color': ((56, 52, 81),(44, 50, 66),(239, 146, 119),(16, 20, 20),(42, 40, 57),(254, 104, 112),)
  },
  'ExtraMenus': {
    'pos': ((1052, 334),(645, 276),(614, 289),(77, 48),(46, 1007),(674, 334),),
    'color': ((170, 122, 166),(85, 229, 210),(65, 223, 222),(20, 20, 28),(18, 20, 27),(224, 68, 68),)
  },
  'LeaderBoard': {
    'pos': ((1245, 39),(1099, 45),(235, 124),(331, 473),(234, 1002),(1255, 986),(845, 1010),),
    'color': ((92, 79, 112),(217, 219, 223),(188, 196, 233),(165, 172, 197),(44, 42, 57),(87, 75, 103),(217, 218, 223),)
  },
  'SummonMenus': {
    'pos': ((68, 571),(112, 577),(24, 558),(58, 46),(1791, 95),(1792, 341),(194, 1003),(355, 39),),
    'color': ((16, 20, 20),(239, 144, 118),(254, 105, 113),(44, 50, 69),(243, 41, 43),(34, 249, 237),(40, 40, 55),(211, 211, 219),)
  },
  'ArenaSelection': {
    'pos': ((1423, 204),(1435, 316),(1156, 238),(1087, 292),(1184, 757),),
    'color': ((179, 55, 80),(166, 241, 251),(215, 215, 227),(213, 153, 159),(254, 253, 219),)
  },
  'ArenaProtPage': {
    'pos': ((343, 459),(1249, 35),(896, 57),(136, 915),(89, 409),(148, 1014),(1246, 970),),
    'color': ((165, 172, 197),(91, 78, 109),(219, 220, 224),(213, 220, 253),(146, 204, 235),(48, 50, 69),(93, 80, 111),),
  },
  'ArenaProtSelection': {
    'pos': ((1349, 163),(1353, 230),(1460, 142),(495, 305),(1474, 887),),
    'color': ((48, 87, 65),(104, 110, 120),(219, 220, 221),(223, 231, 255),(233, 204, 153),),
  },
  'MatchVictory': {
    'pos': ((121, 143),(25, 202),(956, 404),(951, 505),(957, 631),(1428, 268),(1425, 718),(1427, 779),),
    'color': ((12, 14, 19),(5, 6, 7),(137, 186, 230),(44, 70, 109),(137, 191, 225),(166, 202, 251),(156, 198, 247),(165, 202, 251),),
  },
  'ArenaCompPage': {
    'pos': ((1247, 34),(971, 41),(74, 38),(72, 1017),(379, 904),(1245, 1002),),
    'color': ((92, 78, 109),(218, 218, 223),(44, 49, 65),(44, 48, 65),(154, 214, 154),(90, 77, 107),)
  },
  'ArenaCompSelection': {
    'pos': ((1543, 139),(1565, 155),(1316, 126),(571, 160),(509, 462),(488, 369),(1575, 886),),
    'color': ((247, 239, 231),(187, 74, 91),(155, 160, 171),(221, 222, 223),(72, 98, 117),(176, 145, 213),(232, 205, 154),)
  },
}

def get_current_stage():
  global Enum
  if graphics.FlagDisableCache or _G.LastFrameCount != _G.FrameCount:
    _G.CurrentStage = None
    _G.LastFrameCount = _G.FrameCount
  else:
    return _G.CurrentStage

  for key in Enum:
    stg = Enum[key]
    if graphics.is_pixel_match(stg['pos'], stg['color']):
      _G.CurrentStage = key
      return key

  return None

def check_pixels(pixstruct):
  return graphics.is_pixel_match(pixstruct['pos'], pixstruct['color'])

LastStage = '_'
def is_stage(stg):
  global LastStage
  s = get_current_stage()
  if s != LastStage:
    _G.log_info("Current stage:", s)
    LastStage = s
  return s and stg in s
